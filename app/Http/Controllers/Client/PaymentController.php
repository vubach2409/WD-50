<?php

namespace App\Http\Controllers\Client;

use App\Models\Carts;
use App\Models\Orders;
use App\Models\Payment;
use App\Models\Shipping;
use App\Models\OrderDetail;
use App\Models\Transaction;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Session;

class PaymentController extends Controller
{
    // Thanh to√°n
            public function CodPayment(Request $request){
                if(isset($_POST['cod'])){
                    
                    //validate tr∆∞·ªõc khi nh·∫≠n d·ªØ li·ªáu
                    $request->validate([
                        'consignee_address' => ['required', 'string', 'max:255'],
                        'consignee_name' => ['required', 'string', 'max:255'],
                        'consignee_phone' => ['required', 'string', 'max:10'],
                        'shipping_id' => ['required', 'integer', 'exists:shippings,id'],
                        'email' => ['required', 'string', 'max:255'],
                        'city' => ['required', 'string', 'max:255'],
                        'subdistrict' => ['required', 'string', 'max:255'],
                    ]);
                    $cartItems = Carts::where('user_id', Auth::id())->with('product')->get();
                    if ($cartItems->isEmpty()) {
                        return redirect()->route('cart')->with('error', 'Gi·ªè h√†ng tr·ªëng!');
                    }
                    
                    $totalPrice = $cartItems->sum(fn($item) => $item->quantity * $item->product->price);
                    $shipping = Shipping::findOrFail($request->shipping_id);
                    $finalTotal = $totalPrice + $shipping->fee;
        
                    DB::beginTransaction();
                    
                    try {
                       
                        // üõí T·∫°o ƒë∆°n h√†ng
                        $order = Orders::create([
                            'user_id' => Auth::id(),
                            'total' =>$finalTotal,
                            'shipping_id' => $shipping->id,
                            'consignee_address' => $request->consignee_address,
                            'shipping_fee' => $shipping->fee,
                            'payment_method' => 'cod',
                            'subdistrict' => $request->subdistrict,
                            'email' => $request->email,
                            'city' => $request->city,
                            'consignee_name' => $request->consignee_name,
                            'consignee_phone' => $request->consignee_phone,   
                            'status' => 'pending',
                            'transaction_id' =>  now()->timestamp . Auth::id(),
                        ]);
                        // th√™m v√†o b·∫£ng payment
                        Payment::create([
                            'order_id' => $order->id,
                            'user_id' => Auth::id(),
                            'payment_method' => 'cod',
                            'amount' => $finalTotal,
                            'status' => 'pending', // Ch·ªù x√°c nh·∫≠n thanh to√°n
                            'transaction_id' => $order->transaction_id
                        ]);
                         
            
                   
                        // th√™m s·∫£n ph·∫©m v√†o ƒë∆°n h√†ng
                        foreach ($cartItems as $item) {
                            OrderDetail::create([
                                'order_id' => $order->id,
                                'product_id' => $item->product_id,
                                'quantity' => $item->quantity,
                                'price' => $item->product->price
                            ]);
                        }
                        
            
                        // üóëÔ∏è X√≥a gi·ªè h√†ng sau khi ƒë·∫∑t h√†ng th√†nh c√¥ng
                        Carts::where('user_id', Auth::id())->delete();
            
                        DB::commit();
            
                        return redirect()->route('thankyou')->with('success', 'ƒê·∫∑t h√†ng th√†nh c√¥ng, ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong th·ªùi gian s·ªõm nh·∫•t!');
                    } catch (\Exception $e) {
                        DB::rollBack();
                        return redirect()->route('thankyou')->with('error', 'ƒê·∫∑t h√†ng th·∫•t b·∫°i!');
                    }
                }           
            }
    //End thanh to√°n cod

    // Thanh to√°n vnpay
            public function vnpayPayment(Request $request){
                // validate tr∆∞·ªõc khi nh·∫≠n d·ªØ li·ªáu
                $request->validate([
                    'consignee_address' => ['required', 'string', 'max:255'],
                    'consignee_name' => ['required', 'string', 'max:255'],
                    'consignee_phone' => ['required', 'string', 'max:10'],
                    'shipping_id' => ['required', 'integer', 'exists:shippings,id'],
                    'email' => ['required', 'string', 'max:255'],
                    'city' => ['required', 'string', 'max:255'],
                    'subdistrict' => ['required', 'string', 'max:255'],
                ]);

                    $cartItems = Carts::where('user_id', Auth::id())->with('product')->get();
                        if ($cartItems->isEmpty()) {
                            return redirect()->route('cart')->with('error', 'Gi·ªè h√†ng tr·ªëng!');
                        }
                        
                        $totalPrice = $cartItems->sum(fn($item) => $item->quantity * $item->product->price);
                        $shipping = Shipping::find($request->shipping_id);
                        if (!$shipping) {
                            return redirect()->back()->with('error', 'Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn kh√¥ng h·ª£p l·ªá.');
                        }
                        $finalTotal = $totalPrice + $shipping->fee;
                if(isset($_POST['redirect'])){
                    date_default_timezone_set('Asia/Ho_Chi_Minh');
                    $vnp_Url = "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html";
                    $vnp_Returnurl = route('thanks.vnpay');
                    $vnp_TmnCode = "TKKV0ZIT";//M√£ website t·∫°i VNPAY 
                    $vnp_HashSecret = "IW37H3W2QZ4UHXJYWORIKP87X6OCGDSA"; //Chu·ªói b√≠ m·∫≠t
                    
                    $vnp_TxnRef = $vnp_TxnRef = now()->timestamp . Auth::id(); //M√£ ƒë∆°n h√†ng. Trong th·ª±c t·∫ø Merchant c·∫ßn insert ƒë∆°n h√†ng v√†o DB v√† g·ª≠i m√£ n√†y sang VNPAY
                    $vnp_OrderInfo = json_encode([
                        'name' => $request->consignee_name,
                        'phone' => $request->consignee_phone,
                        'address' => $request->consignee_address,
                        'shipping' => $request->shipping_id,
                        'email' => $request->email,
                        'city' => $request->city,
                        'subdistrict' => $request->subdistrict,
                    ]);
                    $vnp_OrderType = "billpayment";
                    $vnp_Amount = $finalTotal * 100; // gi√°
                    $vnp_Locale = "vn";
                    $vnp_BankCode = "NCB";
                    $vnp_IpAddr = request()->ip();
                
                    $inputData = array(
                        "vnp_Version" => "2.1.0",
                        "vnp_TmnCode" => $vnp_TmnCode,
                        "vnp_Amount" => $vnp_Amount,
                        "vnp_Command" => "pay",
                        "vnp_CreateDate" => date('YmdHis'),
                        "vnp_CurrCode" => "VND",
                        "vnp_IpAddr" => $vnp_IpAddr,
                        "vnp_Locale" => $vnp_Locale,
                        "vnp_OrderInfo" => $vnp_OrderInfo,
                        "vnp_OrderType" => $vnp_OrderType,
                        "vnp_ReturnUrl" => $vnp_Returnurl,
                        "vnp_TxnRef" => $vnp_TxnRef,
                    );
                    
                    if (isset($vnp_BankCode) && $vnp_BankCode != "") {
                        $inputData['vnp_BankCode'] = $vnp_BankCode;
                    }
                    // if (isset($vnp_Bill_State) && $vnp_Bill_State != "") {
                    //     $inputData['vnp_Bill_State'] = $vnp_Bill_State;
                    // }
                    
                    //var_dump($inputData);
                    ksort($inputData);
                    $query = "";
                    $i = 0;
                    $hashdata = "";
                    foreach ($inputData as $key => $value) {
                        if ($i == 1) {
                            $hashdata .= '&' . urlencode($key) . "=" . urlencode($value);
                        } else {
                            $hashdata .= urlencode($key) . "=" . urlencode($value);
                            $i = 1;
                        }
                        $query .= urlencode($key) . "=" . urlencode($value) . '&';
                    }
                    
                    $vnp_Url = $vnp_Url . "?" . $query;
                    if (isset($vnp_HashSecret)) {
                        $vnpSecureHash =   hash_hmac('sha512', $hashdata, $vnp_HashSecret);//  
                        $vnp_Url .= 'vnp_SecureHash=' . $vnpSecureHash;
                    }
                    $returnData = array('code' => '00'
                        , 'message' => 'success'
                        , 'data' => $vnp_Url);
                        if (isset($_POST['redirect'])) {
                            header('Location: ' . $vnp_Url);
                            die();
                        } else {
                            echo json_encode($returnData);
                        }
                }
            }

    // end thanh to√°n vnpay
       
    // x·ª≠ l√Ω l∆∞u ƒë∆°n h√†ng v√† giao d·ªãch sau khi thanh to√°n vnpay
        public function xuly(Request $request){
            DB::beginTransaction(); // B·∫Øt ƒë·∫ßu transaction ƒë·ªÉ ƒë·∫£m b·∫£o to√†n v·∫πn d·ªØ li·ªáu
                
            try {
                // Nh·∫≠n d·ªØ li·ªáu t·ª´ VNPay
                $vnp_TxnRef = $request->input('vnp_TxnRef');
                $vnp_ResponseCode = $request->input('vnp_ResponseCode');
                $vnp_OrderInfo = json_decode($request->input('vnp_OrderInfo'), true);
        
                // Ki·ªÉm tra thanh to√°n th√†nh c√¥ng
                      
                if ($vnp_ResponseCode != "00") {
                    return redirect()->route('thankyou')->with('error', 'ƒê·∫∑t h√†ng th·∫•t b·∫°i!');
                }

                $user = Auth::user();
                if (!$user) {
                    return redirect()->route('thankyou')->with('error', 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!');
                }

                $cartItems = Carts::where('user_id', Auth::id())->with('product')->get();
                if ($cartItems->isEmpty()) {
                    return redirect()->route('cart')->with('error', 'Gi·ªè h√†ng tr·ªëng!');
                }
                
                $shipping = Shipping::where('id', $vnp_OrderInfo['shipping'])->first();
                if (!$shipping) {
                    return redirect()->route('thankyou')->with('error', 'Th√¥ng tin v·∫≠n chuy·ªÉn kh√¥ng h·ª£p l·ªá!');
                }
        
                // T√≠nh t·ªïng ti·ªÅn
                $totalPrice = $cartItems->sum(fn($item) => $item->quantity * $item->product->price);
                $finalTotal = $totalPrice + $shipping->fee;
                        $order = Orders::create([
                            'transaction_id' => $vnp_TxnRef,
                            'user_id' => $user->id,
                            'total' => $finalTotal,
                            'shipping_fee' => $shipping->fee,
                            'payment_method' => 'vnpay',
                            'consignee_name' => $vnp_OrderInfo['name'],
                            'subdistrict' => $vnp_OrderInfo['subdistrict'],
                            'email' => $vnp_OrderInfo['email'],
                            'city' => $vnp_OrderInfo['city'],
                            'consignee_phone' => $vnp_OrderInfo['phone'],
                            'consignee_address' => $vnp_OrderInfo['address'],
                            'status' => 'pending',
                           'shipping_id' => $shipping->id,
                        ]);

                        Transaction::create([
                            'user_id' => $user->id,
                            'order_id' => $order->id,
                            'transaction_id' => $vnp_TxnRef,
                            'amount' => $totalPrice,
                            'payment_method' => 'vnpay',
                            'status' => 'success',
                            'response_code' => $vnp_ResponseCode,
                            'response_message' => 'Thanh to√°n th√†nh c√¥ng'
                        ]);

                        Payment::create([
                            'order_id' => $order->id,
                            'user_id' => Auth::id(),
                            'payment_method' => 'vnpay',
                            'amount' => $finalTotal,
                            'status' => 'success', // Ch·ªù x√°c nh·∫≠n thanh to√°n
                            'transaction_id' => $vnp_TxnRef,
                        ]);
                
                        // L∆∞u v√†o b·∫£ng order_items
                        foreach ($cartItems as $item) {
                            OrderDetail::create([
                                'order_id' => $order->id,
                                'product_id' => $item->product_id,
                                'quantity' => $item->quantity,
                                'price' => $item->product->price
                            ]);
                        }
                
                        // X√≥a gi·ªè h√†ng sau khi ƒë·∫∑t h√†ng th√†nh c√¥ng
                        Carts::where('user_id', Auth::id())->delete();
                
                        DB::commit(); // X√°c nh·∫≠n giao d·ªãch
                
                        return redirect()->route('thankyou')->with('success', 'ƒê·∫∑t h√†ng th√†nh c√¥ng, ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong th·ªùi gian s·ªõm nh·∫•t!');
                    } catch (\Exception $e) {
                        DB::rollBack(); // N·∫øu c√≥ l·ªói, rollback d·ªØ li·ªáu
                        return redirect()->route('thankyou')->with('error', 'C√≥ l·ªói x·∫£y ra: ' . $e->getMessage());
                    }
        }

    // end x·ª≠ l√Ω

    // thankyou
                public function thankyou(){
                    return view('client.thankyou');
                }
    // end thankyouu
}

              


